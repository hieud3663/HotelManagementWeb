# Thi·∫øt k·∫ø l·∫°i Lu·ªìng Thanh to√°n v√† Tr·∫£ ph√≤ng

## üìã T·ªïng quan

Thay ƒë·ªïi l·ªõn trong lu·ªìng thanh to√°n v·ªõi **2 t√πy ch·ªçn** cho kh√°ch h√†ng:

### **Option 1: Tr·∫£ ph√≤ng v√† Thanh to√°n** ‚è∞
- Kh√°ch checkout ‚Üí T√≠nh ti·ªÅn theo **th·ªùi gian th·ª±c t·∫ø** (t·ª´ check-in th·ª±c t·∫ø ƒë·∫øn check-out th·ª±c t·∫ø)
- T·∫°o h√≥a ƒë∆°n nh∆∞ng **ch∆∞a thanh to√°n ngay**
- Chuy·ªÉn sang b∆∞·ªõc "X√°c nh·∫≠n thanh to√°n"
- Ph√≤ng **ch∆∞a ƒë∆∞·ª£c gi·∫£i ph√≥ng** cho ƒë·∫øn khi thanh to√°n xong

### **Option 2: Thanh to√°n tr∆∞·ªõc** üí∞
- Kh√°ch thanh to√°n **tr∆∞·ªõc khi** tr·∫£ ph√≤ng
- T√≠nh ti·ªÅn t·ª´ **check-in th·ª±c t·∫ø** ƒë·∫øn **check-out d·ª± ki·∫øn**
- T·∫°o h√≥a ƒë∆°n v√† **x√°c nh·∫≠n thanh to√°n ngay**
- Kh√°ch v·∫´n ·ªü l·∫°i ph√≤ng cho ƒë·∫øn check-out d·ª± ki·∫øn
- Khi th·ª±c s·ª± checkout, n·∫øu checkout mu·ªôn s·∫Ω t√≠nh ph·ª• ph√≠ b·ªï sung

---

## üîÑ Lu·ªìng m·ªõi

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   KH√ÅCH H√ÄNG ƒê CHECK-IN                        ‚îÇ
‚îÇ                   (Ph√≤ng = ON_USE)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 v
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ   KH√ÅCH H√ÄNG QUY·∫æT ƒê·ªäNH   ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                 ‚îÇ
        v                 v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  OPTION 1:    ‚îÇ  ‚îÇ   OPTION 2:      ‚îÇ
‚îÇ  TR·∫¢ PH√íNG &  ‚îÇ  ‚îÇ  THANH TO√ÅN TR∆Ø·ªöC‚îÇ
‚îÇ  THANH TO√ÅN   ‚îÇ  ‚îÇ                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                   ‚îÇ
        ‚îÇ                   ‚îÇ
        v                   v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Checkout NOW ‚îÇ  ‚îÇ 1. T√≠nh ti·ªÅn:    ‚îÇ
‚îÇ 2. T√≠nh ti·ªÅn:   ‚îÇ  ‚îÇ    checkInActual ‚îÇ
‚îÇ    checkInActual‚îÇ  ‚îÇ    -> checkOut   ‚îÇ
‚îÇ    -> checkOut  ‚îÇ  ‚îÇ    EXPECTED      ‚îÇ
‚îÇ    ACTUAL       ‚îÇ  ‚îÇ 2. T·∫°o Invoice   ‚îÇ
‚îÇ 3. T·∫°o Invoice  ‚îÇ  ‚îÇ 3. THANH TO√ÅN    ‚îÇ
‚îÇ    (UNPAID)     ‚îÇ  ‚îÇ    NGAY          ‚îÇ
‚îÇ 4. Ph√≤ng LOCKED ‚îÇ  ‚îÇ 4. Ph√≤ng v·∫´n     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ    ON_USE        ‚îÇ
         ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         v                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ X√ÅC NH·∫¨N        ‚îÇ           ‚îÇ
‚îÇ THANH TO√ÅN      ‚îÇ           ‚îÇ
‚îÇ (Payment Page)  ‚îÇ           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
         ‚îÇ                    ‚îÇ
         v                    v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Invoice.isPaid  ‚îÇ  ‚îÇ Kh√°ch ·ªü ti·∫øp     ‚îÇ
‚îÇ = TRUE          ‚îÇ  ‚îÇ ƒë·∫øn checkout     ‚îÇ
‚îÇ Ph√≤ng AVAILABLE ‚îÇ  ‚îÇ d·ª± ki·∫øn          ‚îÇ
‚îÇ Ho√†n t·∫•t        ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
                              v
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ Checkout th·ª±c t·∫ø ‚îÇ
                     ‚îÇ - N·∫øu ƒë√∫ng gi·ªù:  ‚îÇ
                     ‚îÇ   Done           ‚îÇ
                     ‚îÇ - N·∫øu mu·ªôn:      ‚îÇ
                     ‚îÇ   T√≠nh ph·ª• ph√≠   ‚îÇ
                     ‚îÇ   b·ªï sung        ‚îÇ
                     ‚îÇ Ph√≤ng AVAILABLE  ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä Thay ƒë·ªïi Database Schema

### 1. B·∫£ng Invoice - Th√™m tr∆∞·ªùng tr·∫°ng th√°i

```sql
ALTER TABLE Invoice
ADD isPaid BIT NOT NULL DEFAULT 0,  -- 0 = Ch∆∞a thanh to√°n, 1 = ƒê√£ thanh to√°n
    paymentDate DATETIME NULL,       -- Ng√†y thanh to√°n th·ª±c t·∫ø
    paymentMethod NVARCHAR(20) NULL, -- CASH, CARD, TRANSFER
    checkoutType NVARCHAR(20) NULL;  -- 'CHECKOUT_THEN_PAY' ho·∫∑c 'PAY_THEN_CHECKOUT'
GO
```

### 2. B·∫£ng HistoryCheckOut - Th√™m tr∆∞·ªùng invoice

```sql
ALTER TABLE HistoryCheckOut
ADD invoiceID NVARCHAR(15) NULL,
FOREIGN KEY (invoiceID) REFERENCES Invoice(invoiceID);
GO
```

---

## üîß Stored Procedures M·ªõi

### 1. `sp_CreateInvoice_CheckoutThenPay` - Tr·∫£ ph√≤ng r·ªìi thanh to√°n

```sql
CREATE OR ALTER PROCEDURE sp_CreateInvoice_CheckoutThenPay
    @reservationFormID NVARCHAR(15),
    @employeeID NVARCHAR(15)
AS
BEGIN
    SET NOCOUNT ON;
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- Ki·ªÉm tra ƒë√£ check-in ch∆∞a
        IF NOT EXISTS (SELECT 1 FROM HistoryCheckin WHERE reservationFormID = @reservationFormID)
        BEGIN
            RAISERROR('Phi·∫øu ƒë·∫∑t ph√≤ng ch∆∞a check-in', 16, 1);
            ROLLBACK; RETURN -1;
        END
        
        -- Ki·ªÉm tra ƒë√£ checkout ch∆∞a
        IF EXISTS (SELECT 1 FROM HistoryCheckOut WHERE reservationFormID = @reservationFormID)
        BEGIN
            RAISERROR('Phi·∫øu ƒë·∫∑t ph√≤ng ƒë√£ checkout', 16, 1);
            ROLLBACK; RETURN -1;
        END
        
        -- L·∫•y th√¥ng tin
        DECLARE @roomID NVARCHAR(15);
        SELECT @roomID = roomID FROM ReservationForm WHERE reservationFormID = @reservationFormID;
        
        -- T·∫°o HistoryCheckOut v·ªõi th·ªùi gian HI·ªÜN T·∫†I
        DECLARE @checkOutID NVARCHAR(15) = dbo.fn_GenerateID('CO-', 'HistoryCheckOut', 'historyCheckOutID', 6);
        
        INSERT INTO HistoryCheckOut (historyCheckOutID, checkOutDate, reservationFormID, employeeID)
        VALUES (@checkOutID, GETDATE(), @reservationFormID, @employeeID);
        
        -- T·∫°o Invoice (Trigger s·∫Ω t·ª± ƒë·ªông t√≠nh to√°n d·ª±a tr√™n checkOutActual)
        DECLARE @invoiceID NVARCHAR(15) = dbo.fn_GenerateID('INV-', 'Invoice', 'invoiceID', 6);
        
        INSERT INTO Invoice (invoiceID, invoiceDate, roomCharge, servicesCharge, reservationFormID, isPaid, checkoutType)
        VALUES (@invoiceID, GETDATE(), 0, 0, @reservationFormID, 0, 'CHECKOUT_THEN_PAY');
        
        -- C·∫≠p nh·∫≠t invoiceID v√†o HistoryCheckOut
        UPDATE HistoryCheckOut SET invoiceID = @invoiceID WHERE historyCheckOutID = @checkOutID;
        
        -- C·∫≠p nh·∫≠t tr·∫°ng th√°i ph√≤ng th√†nh LOCKED (ƒë·ª£i thanh to√°n)
        UPDATE Room SET roomStatus = 'UNAVAILABLE' WHERE roomID = @roomID;
        
        -- Tr·∫£ v·ªÅ th√¥ng tin invoice
        SELECT 
            inv.invoiceID,
            inv.roomCharge,
            inv.servicesCharge,
            inv.totalAmount,
            inv.isPaid,
            inv.checkoutType,
            @checkOutID AS checkOutID
        FROM Invoice inv
        WHERE inv.invoiceID = @invoiceID;
        
        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0 ROLLBACK;
        THROW;
    END CATCH
END;
GO
```

### 2. `sp_CreateInvoice_PayThenCheckout` - Thanh to√°n tr∆∞·ªõc

```sql
CREATE OR ALTER PROCEDURE sp_CreateInvoice_PayThenCheckout
    @reservationFormID NVARCHAR(15),
    @employeeID NVARCHAR(15),
    @paymentMethod NVARCHAR(20) = 'CASH'
AS
BEGIN
    SET NOCOUNT ON;
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- Ki·ªÉm tra ƒë√£ check-in ch∆∞a
        IF NOT EXISTS (SELECT 1 FROM HistoryCheckin WHERE reservationFormID = @reservationFormID)
        BEGIN
            RAISERROR('Phi·∫øu ƒë·∫∑t ph√≤ng ch∆∞a check-in', 16, 1);
            ROLLBACK; RETURN -1;
        END
        
        -- Ki·ªÉm tra ƒë√£ c√≥ invoice ch∆∞a
        IF EXISTS (SELECT 1 FROM Invoice WHERE reservationFormID = @reservationFormID)
        BEGIN
            RAISERROR('H√≥a ƒë∆°n ƒë√£ t·ªìn t·∫°i', 16, 1);
            ROLLBACK; RETURN -1;
        END
        
        -- T·∫°o Invoice v·ªõi checkOutDate = Expected (ch∆∞a checkout th·ª±c t·∫ø)
        -- Trigger s·∫Ω t√≠nh d·ª±a tr√™n checkInActual -> checkOutExpected
        DECLARE @invoiceID NVARCHAR(15) = dbo.fn_GenerateID('INV-', 'Invoice', 'invoiceID', 6);
        
        INSERT INTO Invoice (
            invoiceID, invoiceDate, roomCharge, servicesCharge, 
            reservationFormID, isPaid, paymentDate, paymentMethod, checkoutType
        )
        VALUES (
            @invoiceID, GETDATE(), 0, 0, 
            @reservationFormID, 1, GETDATE(), @paymentMethod, 'PAY_THEN_CHECKOUT'
        );
        
        -- Ph√≤ng v·∫´n ON_USE, kh√°ch ti·∫øp t·ª•c ·ªü
        
        -- Tr·∫£ v·ªÅ th√¥ng tin invoice
        SELECT 
            inv.invoiceID,
            inv.roomCharge,
            inv.servicesCharge,
            inv.totalAmount,
            inv.isPaid,
            inv.paymentDate,
            inv.paymentMethod,
            inv.checkoutType
        FROM Invoice inv
        WHERE inv.invoiceID = @invoiceID;
        
        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0 ROLLBACK;
        THROW;
    END CATCH
END;
GO
```

### 3. `sp_ConfirmPayment` - X√°c nh·∫≠n thanh to√°n (cho Option 1)

```sql
CREATE OR ALTER PROCEDURE sp_ConfirmPayment
    @invoiceID NVARCHAR(15),
    @paymentMethod NVARCHAR(20) = 'CASH',
    @employeeID NVARCHAR(15)
AS
BEGIN
    SET NOCOUNT ON;
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- Ki·ªÉm tra invoice t·ªìn t·∫°i
        IF NOT EXISTS (SELECT 1 FROM Invoice WHERE invoiceID = @invoiceID)
        BEGIN
            RAISERROR('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n', 16, 1);
            ROLLBACK; RETURN -1;
        END
        
        -- Ki·ªÉm tra ƒë√£ thanh to√°n ch∆∞a
        DECLARE @isPaid BIT;
        SELECT @isPaid = isPaid FROM Invoice WHERE invoiceID = @invoiceID;
        
        IF @isPaid = 1
        BEGIN
            RAISERROR('H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c thanh to√°n', 16, 1);
            ROLLBACK; RETURN -1;
        END
        
        -- C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n
        UPDATE Invoice
        SET isPaid = 1,
            paymentDate = GETDATE(),
            paymentMethod = @paymentMethod
        WHERE invoiceID = @invoiceID;
        
        -- L·∫•y roomID ƒë·ªÉ gi·∫£i ph√≥ng ph√≤ng
        DECLARE @roomID NVARCHAR(15);
        SELECT @roomID = rf.roomID
        FROM Invoice inv
        JOIN ReservationForm rf ON inv.reservationFormID = rf.reservationFormID
        WHERE inv.invoiceID = @invoiceID;
        
        -- Gi·∫£i ph√≥ng ph√≤ng
        UPDATE Room SET roomStatus = 'AVAILABLE' WHERE roomID = @roomID;
        
        -- Tr·∫£ v·ªÅ th√¥ng tin
        SELECT 
            invoiceID,
            isPaid,
            paymentDate,
            paymentMethod,
            totalAmount
        FROM Invoice
        WHERE invoiceID = @invoiceID;
        
        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0 ROLLBACK;
        THROW;
    END CATCH
END;
GO
```

### 4. `sp_ActualCheckout_AfterPrepayment` - Checkout th·ª±c t·∫ø sau khi thanh to√°n tr∆∞·ªõc

```sql
CREATE OR ALTER PROCEDURE sp_ActualCheckout_AfterPrepayment
    @reservationFormID NVARCHAR(15),
    @employeeID NVARCHAR(15)
AS
BEGIN
    SET NOCOUNT ON;
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- Ki·ªÉm tra ƒë√£ thanh to√°n ch∆∞a
        DECLARE @invoiceID NVARCHAR(15);
        DECLARE @isPaid BIT;
        
        SELECT @invoiceID = invoiceID, @isPaid = isPaid
        FROM Invoice
        WHERE reservationFormID = @reservationFormID;
        
        IF @invoiceID IS NULL OR @isPaid = 0
        BEGIN
            RAISERROR('Ph·∫£i thanh to√°n tr∆∞·ªõc khi checkout', 16, 1);
            ROLLBACK; RETURN -1;
        END
        
        -- Ki·ªÉm tra ƒë√£ checkout ch∆∞a
        IF EXISTS (SELECT 1 FROM HistoryCheckOut WHERE reservationFormID = @reservationFormID)
        BEGIN
            RAISERROR('ƒê√£ checkout r·ªìi', 16, 1);
            ROLLBACK; RETURN -1;
        END
        
        -- L·∫•y th√¥ng tin
        DECLARE @roomID NVARCHAR(15);
        DECLARE @checkOutExpected DATETIME;
        DECLARE @checkOutActual DATETIME = GETDATE();
        
        SELECT 
            @roomID = rf.roomID,
            @checkOutExpected = rf.checkOutDate
        FROM ReservationForm rf
        WHERE rf.reservationFormID = @reservationFormID;
        
        -- T·∫°o HistoryCheckOut
        DECLARE @checkOutID NVARCHAR(15) = dbo.fn_GenerateID('CO-', 'HistoryCheckOut', 'historyCheckOutID', 6);
        
        INSERT INTO HistoryCheckOut (historyCheckOutID, checkOutDate, reservationFormID, employeeID, invoiceID)
        VALUES (@checkOutID, @checkOutActual, @reservationFormID, @employeeID, @invoiceID);
        
        -- Ki·ªÉm tra checkout mu·ªôn
        DECLARE @additionalCharge DECIMAL(18,2) = 0;
        
        IF @checkOutActual > @checkOutExpected
        BEGIN
            -- T√≠nh ph·ª• ph√≠ checkout mu·ªôn
            -- Trigger TR_Invoice_ManageUpdate s·∫Ω t·ª± ƒë·ªông t√≠nh l·∫°i lateCheckoutFee
            UPDATE Invoice 
            SET invoiceDate = GETDATE()  -- Force trigger update
            WHERE invoiceID = @invoiceID;
            
            SELECT @additionalCharge = lateCheckoutFee
            FROM Invoice
            WHERE invoiceID = @invoiceID;
        END
        
        -- Gi·∫£i ph√≥ng ph√≤ng
        UPDATE Room SET roomStatus = 'AVAILABLE' WHERE roomID = @roomID;
        
        -- Tr·∫£ v·ªÅ th√¥ng tin
        SELECT 
            @checkOutID AS checkOutID,
            @checkOutActual AS checkOutDate,
            @checkOutExpected AS checkOutExpected,
            @additionalCharge AS additionalCharge,
            CASE 
                WHEN @additionalCharge > 0 THEN 'LATE_CHECKOUT'
                ELSE 'ON_TIME'
            END AS checkoutStatus
        FROM Invoice
        WHERE invoiceID = @invoiceID;
        
        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0 ROLLBACK;
        THROW;
    END CATCH
END;
GO
```

---

## üîÑ S·ª≠a Trigger Invoice

### Trigger ph·∫£i x·ª≠ l√Ω 2 tr∆∞·ªùng h·ª£p:

**Case 1: CHECKOUT_THEN_PAY**
- T√≠nh t·ª´ `checkInActual` ‚Üí `checkOutActual` (ƒë√£ c√≥ trong HistoryCheckOut)

**Case 2: PAY_THEN_CHECKOUT**
- T√≠nh t·ª´ `checkInActual` ‚Üí `checkOutExpected` (ch∆∞a checkout)
- Khi checkout th·ª±c t·∫ø, n·∫øu mu·ªôn ‚Üí trigger UPDATE s·∫Ω t√≠nh th√™m ph·ª• ph√≠

```sql
-- ƒê√£ c√≥ trigger TR_Invoice_ManageInsert v√† TR_Invoice_ManageUpdate
-- Ch√∫ng s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω d·ª±a tr√™n:
-- - N·∫øu c√≥ checkOutActual ‚Üí d√πng checkOutActual
-- - N·∫øu ch∆∞a c√≥ ‚Üí d√πng checkOutExpected

-- Trigger hi·ªán t·∫°i ƒê√É ƒê√öNG v·ªõi logic n√†y:
-- @effectiveCheckOut = ISNULL(@checkOutDateActual, @checkOutDateExpected)
```

---

## üé® Controller Changes

### CheckOutController - 2 Actions m·ªõi

```csharp
// Option 1: Checkout r·ªìi thanh to√°n
[HttpPost]
public async Task<IActionResult> CheckoutThenPay(string reservationFormID)
{
    var result = await _context.CreateInvoice_CheckoutThenPay(reservationFormID, employeeID);
    
    if (result != null)
    {
        TempData["Success"] = "Checkout th√†nh c√¥ng. Vui l√≤ng thanh to√°n.";
        return RedirectToAction("Payment", new { invoiceID = result.InvoiceID });
    }
    
    TempData["Error"] = "Checkout th·∫•t b·∫°i";
    return RedirectToAction("Index");
}

// Option 2: Thanh to√°n tr∆∞·ªõc
[HttpPost]
public async Task<IActionResult> PayThenCheckout(string reservationFormID, string paymentMethod)
{
    var result = await _context.CreateInvoice_PayThenCheckout(reservationFormID, employeeID, paymentMethod);
    
    if (result != null)
    {
        TempData["Success"] = "Thanh to√°n th√†nh c√¥ng. Qu√Ω kh√°ch c√≥ th·ªÉ ·ªü ƒë·∫øn " + checkOutExpected;
        return RedirectToAction("Receipt", new { invoiceID = result.InvoiceID });
    }
    
    TempData["Error"] = "Thanh to√°n th·∫•t b·∫°i";
    return RedirectToAction("Index");
}

// Trang x√°c nh·∫≠n thanh to√°n (cho Option 1)
[HttpGet]
public async Task<IActionResult> Payment(string invoiceID)
{
    var invoice = await _context.Invoices
        .Include(i => i.ReservationForm)
        .ThenInclude(rf => rf.Customer)
        .FirstOrDefaultAsync(i => i.InvoiceID == invoiceID);
    
    return View(invoice);
}

[HttpPost]
public async Task<IActionResult> ConfirmPayment(string invoiceID, string paymentMethod)
{
    var result = await _context.ConfirmPayment(invoiceID, paymentMethod, employeeID);
    
    if (result != null)
    {
        TempData["Success"] = "Thanh to√°n th√†nh c√¥ng!";
        return RedirectToAction("Receipt", new { invoiceID });
    }
    
    TempData["Error"] = "Thanh to√°n th·∫•t b·∫°i";
    return RedirectToAction("Payment", new { invoiceID });
}

// Checkout th·ª±c t·∫ø sau khi ƒë√£ thanh to√°n tr∆∞·ªõc
[HttpPost]
public async Task<IActionResult> ActualCheckout(string reservationFormID)
{
    var result = await _context.ActualCheckout_AfterPrepayment(reservationFormID, employeeID);
    
    if (result != null)
    {
        if (result.CheckoutStatus == "LATE_CHECKOUT" && result.AdditionalCharge > 0)
        {
            TempData["Warning"] = $"Checkout mu·ªôn. Ph·ª• ph√≠: {result.AdditionalCharge:N0} VNƒê";
            return RedirectToAction("AdditionalPayment", new { invoiceID = result.InvoiceID });
        }
        
        TempData["Success"] = "Checkout th√†nh c√¥ng!";
        return RedirectToAction("Index");
    }
    
    TempData["Error"] = "Checkout th·∫•t b·∫°i";
    return RedirectToAction("Index");
}
```

---

## üì± Views Changes

### CheckOut/Index.cshtml - 2 n√∫t cho m·ªói ph√≤ng

```razor
@foreach (var item in Model)
{
    <tr>
        <!-- ... th√¥ng tin ph√≤ng ... -->
        <td>
            @if (item.Invoice == null)
            {
                <!-- Ch∆∞a c√≥ invoice -> hi·ªÉn th·ªã 2 n√∫t -->
                <div class="btn-group">
                    <!-- N√∫t 1: Thanh to√°n tr∆∞·ªõc -->
                    <button type="button" class="btn btn-success btn-sm" 
                            onclick="showPaymentMethodModal('@item.ReservationFormID', 'prepay')">
                        <i class="fas fa-money-bill-wave"></i> Thanh to√°n tr∆∞·ªõc
                    </button>
                    
                    <!-- N√∫t 2: Tr·∫£ ph√≤ng & Thanh to√°n -->
                    <form asp-action="CheckoutThenPay" method="post" class="d-inline">
                        <input type="hidden" name="reservationFormID" value="@item.ReservationFormID" />
                        <button type="submit" class="btn btn-warning btn-sm"
                                onclick="return confirm('X√°c nh·∫≠n tr·∫£ ph√≤ng?')">
                            <i class="fas fa-sign-out-alt"></i> Tr·∫£ ph√≤ng & Thanh to√°n
                        </button>
                    </form>
                </div>
            }
            else if (!item.Invoice.IsPaid)
            {
                <!-- ƒê√£ checkout nh∆∞ng ch∆∞a thanh to√°n -->
                <a asp-action="Payment" asp-route-invoiceID="@item.Invoice.InvoiceID" 
                   class="btn btn-danger btn-sm">
                    <i class="fas fa-exclamation-triangle"></i> Ch·ªù thanh to√°n
                </a>
            }
            else if (item.HistoryCheckOut == null)
            {
                <!-- ƒê√£ thanh to√°n nh∆∞ng ch∆∞a checkout -->
                <form asp-action="ActualCheckout" method="post" class="d-inline">
                    <input type="hidden" name="reservationFormID" value="@item.ReservationFormID" />
                    <button type="submit" class="btn btn-info btn-sm"
                            onclick="return confirm('X√°c nh·∫≠n tr·∫£ ph√≤ng?')">
                        <i class="fas fa-door-open"></i> Tr·∫£ ph√≤ng
                    </button>
                </form>
            }
            else
            {
                <span class="badge bg-success">Ho√†n t·∫•t</span>
            }
        </td>
    </tr>
}
```

### CheckOut/Payment.cshtml - Trang x√°c nh·∫≠n thanh to√°n

```razor
@model Invoice

<div class="card">
    <div class="card-header bg-warning text-white">
        <h4><i class="fas fa-money-bill"></i> X√°c nh·∫≠n thanh to√°n</h4>
    </div>
    <div class="card-body">
        <h5>Th√¥ng tin kh√°ch h√†ng</h5>
        <p><strong>Kh√°ch h√†ng:</strong> @Model.ReservationForm.Customer.FullName</p>
        <p><strong>Ph√≤ng:</strong> @Model.ReservationForm.RoomID</p>
        
        <hr />
        
        <h5>Chi ti·∫øt h√≥a ƒë∆°n</h5>
        <table class="table">
            <tr>
                <td>Ti·ªÅn ph√≤ng:</td>
                <td class="text-end">@Model.RoomCharge.ToString("N0") VNƒê</td>
            </tr>
            <tr>
                <td>Ti·ªÅn d·ªãch v·ª•:</td>
                <td class="text-end">@Model.ServicesCharge.ToString("N0") VNƒê</td>
            </tr>
            <tr>
                <td>Ti·ªÅn c·ªçc:</td>
                <td class="text-end">-@Model.RoomBookingDeposit.ToString("N0") VNƒê</td>
            </tr>
            <tr class="fw-bold">
                <td>T·ªïng c·ªông:</td>
                <td class="text-end text-danger">@Model.TotalAmount.ToString("N0") VNƒê</td>
            </tr>
        </table>
        
        <hr />
        
        <form asp-action="ConfirmPayment" method="post">
            <input type="hidden" name="invoiceID" value="@Model.InvoiceID" />
            
            <div class="mb-3">
                <label>Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
                <select name="paymentMethod" class="form-select" required>
                    <option value="CASH">Ti·ªÅn m·∫∑t</option>
                    <option value="CARD">Th·∫ª</option>
                    <option value="TRANSFER">Chuy·ªÉn kho·∫£n</option>
                </select>
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-check"></i> X√°c nh·∫≠n thanh to√°n @Model.TotalAmount.ToString("N0") VNƒê
                </button>
                <a asp-action="Index" class="btn btn-secondary">Quay l·∫°i</a>
            </div>
        </form>
    </div>
</div>
```

---

## üìã Checklist Implementation

### ‚úÖ Database Changes
- [ ] Ch·∫°y ALTER TABLE ƒë·ªÉ th√™m c·ªôt v√†o Invoice
- [ ] Ch·∫°y ALTER TABLE ƒë·ªÉ th√™m c·ªôt v√†o HistoryCheckOut
- [ ] T·∫°o stored procedures m·ªõi
- [ ] Test trigger v·ªõi 2 tr∆∞·ªùng h·ª£p

### ‚úÖ Backend Changes
- [ ] T·∫°o DatabaseExtensions methods cho SPs m·ªõi
- [ ] C·∫≠p nh·∫≠t CheckOutController v·ªõi 4 actions m·ªõi
- [ ] C·∫≠p nh·∫≠t Invoice model v·ªõi c√°c property m·ªõi
- [ ] Test logic thanh to√°n

### ‚úÖ Frontend Changes
- [ ] C·∫≠p nh·∫≠t CheckOut/Index.cshtml v·ªõi 2 n√∫t
- [ ] T·∫°o CheckOut/Payment.cshtml
- [ ] T·∫°o modal ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
- [ ] C·∫≠p nh·∫≠t CSS/JS

### ‚úÖ Testing
- [ ] Test Option 1: Checkout ‚Üí Payment ‚Üí Done
- [ ] Test Option 2: Prepay ‚Üí Stay ‚Üí Checkout on time
- [ ] Test Option 2: Prepay ‚Üí Stay ‚Üí Late checkout v·ªõi ph·ª• ph√≠
- [ ] Test Invoice trigger v·ªõi c·∫£ 2 cases
- [ ] Test room status transitions

---

## üéØ K·∫øt qu·∫£ mong ƒë·ª£i

| Lu·ªìng | Th·ªùi ƒëi·ªÉm t√≠nh ti·ªÅn | Invoice.isPaid | Room.status | Ghi ch√∫ |
|-------|-------------------|----------------|-------------|---------|
| **Option 1: Checkout ‚Üí Pay** | CheckIn‚ÜíCheckOut Actual | False ‚Üí True | UNAVAILABLE ‚Üí AVAILABLE | Ph√≤ng kh√≥a ƒë·∫øn khi thanh to√°n |
| **Option 2: Pay ‚Üí Checkout** | CheckIn‚ÜíCheckOut Expected | True | ON_USE ‚Üí AVAILABLE | N·∫øu checkout mu·ªôn ‚Üí ph·ª• ph√≠ |

‚úÖ **Ho√†n th√†nh thi·∫øt k·∫ø!** S·∫µn s√†ng tri·ªÉn khai.
