@model dynamic

@{
    ViewData["Title"] = "Báo cáo Hiệu suất Nhân viên";
}

<!-- Page Header -->
<div class="page-header fade-in-up">
    <h1>
        <i class="fas fa-user-tie"></i>
        Báo cáo Hiệu suất Nhân viên
    </h1>
    <p>Đánh giá hiệu quả làm việc của đội ngũ nhân viên</p>
</div>

<!-- Filter Form -->
<div class="card-modern fade-in-up mb-4">
    <div class="card-body-modern">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label-modern">Từ ngày</label>
                <input type="date" name="fromDate" class="form-control-modern" value="@ViewBag.FromDate" />
            </div>
            <div class="col-md-4">
                <label class="form-label-modern">Đến ngày</label>
                <input type="date" name="toDate" class="form-control-modern" value="@ViewBag.ToDate" />
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary-modern w-100">
                    <i class="fas fa-filter"></i> Lọc dữ liệu
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Top Performer -->
@if (ViewBag.TopEmployee != null)
{
    <div class="card-modern fade-in-up mb-4" style="animation-delay: 0.1s">
        <div class="card-header-modern bg-warning text-white">
            <i class="fas fa-trophy me-2"></i>Nhân viên xuất sắc nhất
        </div>
        <div class="card-body-modern">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3 class="mb-2">
                        <i class="fas fa-star text-warning"></i>
                        @ViewBag.TopEmployee.EmployeeName
                    </h3>
                    <p class="mb-2">
                        <strong>Mã NV:</strong> @ViewBag.TopEmployee.EmployeeID |
                        <strong>Chức vụ:</strong> @ViewBag.TopEmployee.Position
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <h1 class="text-warning mb-0">@ViewBag.TopEmployee.TotalReservations</h1>
                    <p class="text-muted mb-0">Phiếu đặt phòng</p>
                </div>
            </div>
        </div>
    </div>
}

<!-- Summary Statistics -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="stats-card primary fade-in-up" style="animation-delay: 0.2s">
            <div class="stats-icon primary">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stats-title">TỔNG ĐẶT PHÒNG</div>
            <div class="stats-value">@ViewBag.TotalReservations</div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="stats-card success fade-in-up" style="animation-delay: 0.3s">
            <div class="stats-icon success">
                <i class="fas fa-users"></i>
            </div>
            <div class="stats-title">NHÂN VIÊN THAM GIA</div>
            <div class="stats-value">@ViewBag.EmployeeStats.Count</div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row g-4 mb-4">
    <!-- Employee Performance Bar Chart -->
    <div class="col-lg-12">
        <div class="card-modern fade-in-up" style="animation-delay: 0.5s">
            <div class="card-header-modern">
                <i class="fas fa-chart-bar me-2"></i>Biểu đồ Top 10 Nhân viên (Số đặt phòng)
            </div>
            <div class="card-body-modern">
                <canvas id="employeePerformanceChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Employee Deposit Pie Chart -->
    <div class="col-lg-6">
        <div class="card-modern fade-in-up" style="animation-delay: 0.6s">
            <div class="card-header-modern">
                <i class="fas fa-chart-pie me-2"></i>Phân bố Tiền cọc theo Nhân viên
            </div>
            <div class="card-body-modern">
                <canvas id="employeeDepositChart" style="max-height: 350px;"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Performance Rating Chart -->
    <div class="col-lg-6">
        <div class="card-modern fade-in-up" style="animation-delay: 0.7s">
            <div class="card-header-modern">
                <i class="fas fa-star me-2"></i>Phân loại Hiệu suất Nhân viên
            </div>
            <div class="card-body-modern">
                <canvas id="performanceRatingChart" style="max-height: 350px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Employee Performance Table -->
<div class="card-modern fade-in-up" style="animation-delay: 0.8s">
    <div class="card-header-modern">
        <i class="fas fa-chart-bar me-2"></i>Bảng xếp hạng Nhân viên
    </div>
    <div class="card-body-modern">
        <button id='btn-export-excel' class="btn btn-success-modern" style="margin-bottom: 1rem;">
                <i class="fas fa-print"></i> Xuất Excel
        </button>
        @if (ViewBag.EmployeeStats != null && ViewBag.EmployeeStats.Count > 0)
        {
            <div class="table-responsive">
                <table class="table-modern mb-0 w-100" id="rankTable">
                    <thead>
                        <tr>
                            <th><i class="fas fa-medal"></i> Hạng</th>
                            <th><i class="fas fa-hashtag"></i> Mã NV</th>
                            <th><i class="fas fa-user"></i> Họ tên</th>
                            <th><i class="fas fa-briefcase"></i> Chức vụ</th>
                            <th><i class="fas fa-calendar-check"></i> Số đặt phòng</th>
                            <th><i class="fas fa-money-bill"></i> Tổng tiền cọc</th>
                            <th><i class="fas fa-star"></i> Đánh giá</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int rank = 1;
                        }
                        @foreach (var emp in ViewBag.EmployeeStats)
                        {
                            <tr>
                                <td>
                                    @if (rank == 1)
                                    {
                                        <span class="badge-modern" style="background: gold; color: black;">
                                            <i class="fas fa-trophy"></i> #@rank
                                        </span>
                                    }
                                    else if (rank == 2)
                                    {
                                        <span class="badge-modern" style="background: silver; color: black;">
                                            <i class="fas fa-medal"></i> #@rank
                                        </span>
                                    }
                                    else if (rank == 3)
                                    {
                                        <span class="badge-modern" style="background: #CD7F32; color: white;">
                                            <i class="fas fa-medal"></i> #@rank
                                        </span>
                                    }
                                    else
                                    {
                                        <strong>#@rank</strong>
                                    }
                                </td>
                                <td><strong class="text-primary">@emp.EmployeeID</strong></td>
                                <td><strong>@emp.EmployeeName</strong></td>
                                <td>@emp.Position</td>
                                <td>
                                    <span class="badge-modern badge-info-modern">
                                        <i class="fas fa-list"></i> @emp.TotalReservations
                                    </span>
                                </td>
                                <td>
                                    <strong class="text-success">@emp.TotalDeposit.ToString("N0") đ</strong>
                                </td>
                                <td>
                                    @{
                                        var performance = emp.TotalReservations >= 20 ? "Xuất sắc" :
                                                         emp.TotalReservations >= 10 ? "Tốt" :
                                                         emp.TotalReservations >= 5 ? "Khá" : "Trung bình";
                                        var badgeClass = emp.TotalReservations >= 20 ? "badge-success-modern" :
                                                        emp.TotalReservations >= 10 ? "badge-info-modern" :
                                                        emp.TotalReservations >= 5 ? "badge-warning-modern" : "badge-danger-modern";
                                    }
                                    <span class="badge-modern @badgeClass">
                                        <i class="fas fa-star"></i> @performance
                                    </span>
                                </td>
                            </tr>
                            rank++;
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">Không có dữ liệu trong khoảng thời gian này</p>
            </div>
        }
    </div>
</div>

<div class="mt-4">
    <a asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Quay lại
    </a>
</div>

@section Scripts {
<script>
    const employeeData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.EmployeeStats ?? new List<object>()));
    
    if (employeeData && employeeData.length > 0) {
        // 1. Top 10 Employee Performance Bar Chart (Horizontal)
        const top10 = employeeData.slice(0, 10);
        const ctxPerformance = document.getElementById('employeePerformanceChart').getContext('2d');
        new Chart(ctxPerformance, {
            type: 'bar',
            data: {
                labels: top10.map(e => e.EmployeeName),
                datasets: [{
                    label: 'Số đặt phòng',
                    data: top10.map(e => e.TotalReservations),
                    backgroundColor: '#4e73df',
                    borderColor: '#2e59d9',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Số đặt phòng: ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
        
        // 2. Employee Deposit Pie Chart (Top 5)
        const top5 = employeeData.slice(0, 5);
        const ctxDeposit = document.getElementById('employeeDepositChart').getContext('2d');
        new Chart(ctxDeposit, {
            type: 'doughnut',
            data: {
                labels: top5.map(e => e.EmployeeName),
                datasets: [{
                    label: 'Tiền cọc',
                    data: top5.map(e => e.TotalDeposit),
                    backgroundColor: [
                        '#4e73df',
                        '#1cc88a',
                        '#36b9cc',
                        '#f6c23e',
                        '#e74a3b'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value.toLocaleString('vi-VN') + ' đ (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
        
        // 3. Performance Rating Distribution Chart
        const excellent = employeeData.filter(e => e.TotalReservations >= 20).length;
        const good = employeeData.filter(e => e.TotalReservations >= 10 && e.TotalReservations < 20).length;
        const average = employeeData.filter(e => e.TotalReservations >= 5 && e.TotalReservations < 10).length;
        const low = employeeData.filter(e => e.TotalReservations < 5).length;
        
        const ctxRating = document.getElementById('performanceRatingChart').getContext('2d');
        new Chart(ctxRating, {
            type: 'pie',
            data: {
                labels: ['Xuất sắc (>=20)', 'Tốt (10-19)', 'Khá (5-9)', 'Trung bình (<5)'],
                datasets: [{
                    data: [excellent, good, average, low],
                    backgroundColor: [
                        '#1cc88a',
                        '#36b9cc',
                        '#f6c23e',
                        '#e74a3b'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value + ' NV (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // Xuất excel
    exportExcel('rankTable', 'Báo cáo xếp hạng', 'Bao_cao_xep_hang', '@ViewBag.FromDate', '@ViewBag.ToDate');

</script>
}
